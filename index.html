<!DOCTYPE html>
<html lang="en">
<head>
    <meta property="og:title" content="Awesome EPUB Reader | Online Book Reader">
    <meta property="og:description" content="Read EPUB books online with a customizable reader interface. Adjust themes, font sizes, and more.">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://awesome-epub-reader.pages.dev/">

    <link rel="icon" href="favicon.ico" type="image/x-icon"/>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Awesome EPUB Reader</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --bg-color: #1a1a1a;
            --header-bg: #242424;
            --text-color: #e0e0e0;
            --primary: #ff5f5f;
            --hover-color: #333333;
            --border-color: #444444;
            --shadow-color: rgba(0, 0, 0, 0.5);
            --overlay-color: rgba(0, 0, 0, 0.7);
            --button-hover: rgba(255, 95, 95, 0.1);
            --button-active: rgba(255, 95, 95, 0.2);
            --card-bg: #2a2a2a;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            overflow: hidden;
        }
        
        #reader-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
            position: relative;
        }
        
        #header {
            padding: 8px 16px;
            background-color: var(--header-bg);
            color: var(--text-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 5px var(--shadow-color);
            z-index: 10;
            height: 50px;
            position: relative;
        }
        
        .header-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-left {
            flex: 1;
        }
        
        .header-center {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .header-right {
            margin-left: auto;
        }
        
        button {
            background: none;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            padding: 6px 8px;
            border-radius: 4px;
            font-size: 14px;
            color: var(--text-color);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        button:hover {
            background-color: var(--button-hover);
        }
        
        button:active {
            background-color: var(--button-active);
        }
        
        .btn-icon {
            padding: 6px;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            justify-content: center;
        }
        
        #title {
            font-size: 16px;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }
        
        #viewer-container {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: var(--bg-color);
            display: flex;
            flex-direction: column;
            display: none; /* Hidden by default */
        }
        
        #chapter-title {
            padding: 12px 20px;
            font-size: 18px;
            font-weight: 500;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            background-color: var(--header-bg);
        }
        
        #viewer {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            margin: 0 auto;
            width: 100%;
            max-width: 800px;
            scroll-behavior: smooth;
            position: relative;
        }
        
        #viewer-content {
            min-height: 100%;
        }
        
        #viewer::-webkit-scrollbar {
            width: 8px;
        }
        
        #viewer::-webkit-scrollbar-track {
            background: var(--bg-color);
        }
        
        #viewer::-webkit-scrollbar-thumb {
            background-color: var(--border-color);
            border-radius: 4px;
        }
        
        #viewer::-webkit-scrollbar-thumb:hover {
            background-color: var(--primary);
        }
        
        #chapter-navigation {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--header-bg);
            border-radius: 24px;
            padding: 8px;
            display: flex;
            gap: 8px;
            box-shadow: 0 4px 12px var(--shadow-color);
            z-index: 10;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        #reader-container:hover #chapter-navigation {
            opacity: 1;
        }
        
        #page-info {
            font-size: 14px;
            color: var(--text-color);
            opacity: 0.8;
            white-space: nowrap;
        }
        
        #sidebar {
            width: 280px;
            background-color: var(--header-bg);
            position: fixed;
            top: 0;
            bottom: 0;
            left: -280px;
            z-index: 20;
            transition: all 0.3s ease;
            box-shadow: 2px 0 10px var(--shadow-color);
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        
        #sidebar.visible {
            left: 0;
        }
        
        #sidebar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border-color);
        }
        
        #sidebar-title {
            font-size: 18px;
            font-weight: 500;
        }
        
        #sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--overlay-color);
            z-index: 15;
            display: none;
            backdrop-filter: blur(2px);
            transition: all 0.3s ease;
        }
        
        #sidebar-overlay.visible {
            display: block;
        }
        
        .toc-item {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 4px;
        }
        
        .toc-item:hover {
            background-color: var(--hover-color);
        }
        
        .toc-item.active {
            color: var(--primary);
            font-weight: 500;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--overlay-color);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
            gap: 16px;
        }
        
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(224, 224, 224, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        #settings-panel {
            margin-top: 20px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }
        
        .settings-group {
            margin-bottom: 16px;
        }
        
        .settings-title {
            font-size: 14px;
            margin-bottom: 8px;
            color: var(--text-color);
            opacity: 0.8;
        }
        
        .settings-options {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .settings-option {
            padding: 6px 12px;
            background-color: var(--hover-color);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .settings-option.active {
            background-color: var(--primary);
            color: white;
        }
        
        .settings-option:hover:not(.active) {
            background-color: var(--button-hover);
        }
        
        /* Progress bar */
        #progress-container {
            height: 4px;
            background-color: var(--border-color);
            position: relative;
            width: 100%;
        }
        
        #progress-bar {
            height: 100%;
            background-color: var(--primary);
            width: 0;
            transition: width 0.3s;
        }
        
        /* Home/Library screen */
        #library-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--bg-color);
            z-index: 5;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }
        
        #library-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }
        
        #library-title {
            font-size: 24px;
            font-weight: 600;
        }
        
        #link-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 2px dashed var(--border-color);
            border-radius: 8px;
            margin-bottom: 30px;
            transition: all 0.2s ease;
        }
        
        #link-input-container {
            display: flex;
            width: 100%;
            max-width: 600px;
            gap: 10px;
        }
        
        #epub-link {
            flex: 1;
            padding: 10px 15px;
            border-radius: 4px;
            border: 1px solid var(--border-color);
            background-color: var(--header-bg);
            color: var(--text-color);
            font-size: 14px;
        }
        
        #add-link-btn {
            padding: 10px 20px;
            background-color: var(--primary);
            color: white;
            border-radius: 4px;
            font-weight: 500;
        }
        
        #add-link-btn:hover {
            opacity: 0.9;
        }
        
        #add-link-btn:active {
            opacity: 0.8;
        }
        
        #books-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .book-card {
            background-color: var(--card-bg);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.2s ease;
            cursor: pointer;
            position: relative;
        }
        
        .book-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 6px 12px var(--shadow-color);
        }
        
        .book-cover {
            width: 100%;
            height: 180px;
            background-color: var(--hover-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-color);
            font-size: 48px;
            position: relative;
            overflow: hidden;
        }
        
        .book-cover::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 30px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.5), transparent);
            z-index: 1;
        }
        
        .book-cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .book-info {
            padding: 12px;
        }
        
        .book-title {
            font-weight: 500;
            margin-bottom: 4px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .book-author {
            font-size: 14px;
            opacity: 0.8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .book-date {
            font-size: 12px;
            opacity: 0.6;
            margin-top: 4px;
        }
        
        .book-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 4px;
            z-index: 2;
        }
        
        .book-action-btn {
            background-color: var(--overlay-color);
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        
        .book-card:hover .book-action-btn {
            opacity: 1;
        }
        
        .book-action-btn:hover {
            background-color: var(--primary);
        }
        
        /* Empty state */
        #empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 40px 20px;
            grid-column: 1 / -1;
        }
        
        #empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
            color: var(--primary);
        }
        
        #empty-text {
            font-size: 18px;
            margin-bottom: 8px;
        }
        
        #empty-subtext {
            font-size: 14px;
            opacity: 0.8;
            margin-bottom: 16px;
        }
        
        @media (max-width: 768px) {
            #sidebar {
                width: 85%;
                left: -85%;
            }
            
            #title {
                max-width: 180px;
            }
            
            #viewer {
                padding: 15px;
            }
            
            #books-container {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
            
            .book-cover {
                height: 140px;
            }
            
            #link-input-container {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div id="reader-container">
        <div id="header">
            <div class="header-group header-left">
                <button id="toc-toggle" class="btn-icon" title="Table of Contents">
                    <i class="fas fa-bars"></i>
                </button>
                <div id="title">Awesome EPUB Reader</div>
            </div>
            
            <div class="header-group header-center">
                <div id="page-info">Section 1/1</div>
            </div>
            
            <div class="header-group header-right">
                <button id="home-btn" class="btn-icon" title="Library">
                    <i class="fas fa-home"></i>
                </button>
                <button id="fullscreen-btn" class="btn-icon" title="Fullscreen">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
        
        <div id="progress-container">
            <div id="progress-bar"></div>
        </div>
        
        <div id="viewer-container">
            <div id="chapter-title">Loading chapter...</div>
            <div id="viewer">
                <div id="viewer-content"></div>
            </div>
            
            <div id="sidebar-overlay"></div>
            <div id="sidebar">
                <div id="sidebar-header">
                    <div id="sidebar-title">Table of Contents</div>
                    <button id="close-sidebar" class="btn-icon">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="toc"></div>
                
                <div id="settings-panel">
                    <div class="settings-group">
                        <div class="settings-title">Theme</div>
                        <div class="settings-options">
                            <div class="settings-option active" data-theme="dark">Dark</div>
                            <div class="settings-option" data-theme="light">Light</div>
                            <div class="settings-option" data-theme="sepia">Sepia</div>
                        </div>
                    </div>
                    
                    <div class="settings-group">
                        <div class="settings-title">Font Size</div>
                        <div class="settings-options">
                            <button id="font-decrease" class="btn-icon" title="Decrease font size">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button id="font-reset" class="btn-icon" title="Reset font size">
                                <i class="fas fa-font"></i>
                            </button>
                            <button id="font-increase" class="btn-icon" title="Increase font size">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="chapter-navigation">
            <button id="prev-chapter" class="btn-icon" title="Previous Section">
                <i class="fas fa-chevron-left"></i>
            </button>
            <button id="toc-control" class="btn-icon" title="Table of Contents">
                <i class="fas fa-bars"></i>
            </button>
            <button id="settings-control" class="btn-icon" title="Settings">
                <i class="fas fa-cog"></i>
            </button>
            <button id="next-chapter" class="btn-icon" title="Next Section">
                <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <div id="loading">
            <div class="spinner"></div>
            <div>Loading book...</div>
        </div>
        
        <!-- Library/Home Screen -->
        <div id="library-container">
            <div id="library-header">
                <div id="library-title">Your Library</div>
                <button id="close-library" class="btn-icon">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div id="link-container">
                <div id="link-input-container">
                    <input type="text" id="epub-link" placeholder="Enter direct EPUB file URL...">
                    <button id="add-link-btn">Add Book</button>
                </div>
            </div>
            
            <div id="books-container">
                <div id="empty-state">
                    <div id="empty-icon"><i class="fas fa-book-open"></i></div>
                    <div id="empty-text">Your library is empty</div>
                    <div id="empty-subtext">Add your first EPUB file via URL to get started</div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/epubjs@0.3.88/dist/epub.min.js"></script>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const viewer = document.getElementById('viewer');
            const viewerContent = document.getElementById('viewer-content');
            const viewerContainer = document.getElementById('viewer-container');
            const chapterTitle = document.getElementById('chapter-title');
            const prevChapterBtn = document.getElementById('prev-chapter');
            const nextChapterBtn = document.getElementById('next-chapter');
            const pageInfo = document.getElementById('page-info');
            const titleElement = document.getElementById('title');
            const tocToggle = document.getElementById('toc-toggle');
            const tocControl = document.getElementById('toc-control');
            const settingsControl = document.getElementById('settings-control');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebar-overlay');
            const closeSidebar = document.getElementById('close-sidebar');
            const tocElement = document.getElementById('toc');
            const loadingElement = document.getElementById('loading');
            const fullscreenBtn = document.getElementById('fullscreen-btn');
            const fontDecrease = document.getElementById('font-decrease');
            const fontIncrease = document.getElementById('font-increase');
            const fontReset = document.getElementById('font-reset');
            const progressBar = document.getElementById('progress-bar');
            const themeOptions = document.querySelectorAll('[data-theme]');
            const homeBtn = document.getElementById('home-btn');
            const libraryContainer = document.getElementById('library-container');
            const closeLibrary = document.getElementById('close-library');
            const epubLinkInput = document.getElementById('epub-link');
            const addLinkBtn = document.getElementById('add-link-btn');
            const booksContainer = document.getElementById('books-container');
            const emptyState = document.getElementById('empty-state');
            
            // Reader state
            let book;
            let rendition;
            let currentChapterIndex = 0;
            let chapters = [];
            let spineItems = [];
            let fontSize = 18;
            let currentTheme = 'dark';
            let isLoading = false;
            let currentBookId = null;
            
            // Library state
            let library = [];
            const LIBRARY_STORAGE_KEY = 'awesomeEpubReaderLibrary';
            
            // Themes with proper hover colors
            const themes = {
                light: {
                    backgroundColor: '#ffffff',
                    textColor: '#333333',
                    headerBg: '#f0f0f0',
                    borderColor: '#dddddd',
                    hoverColor: '#e6e6e6',
                    primary: '#4285f4',
                    buttonHover: 'rgba(66, 133, 244, 0.1)',
                    buttonActive: 'rgba(66, 133, 244, 0.2)',
                    cardBg: '#f5f5f5',
                    shadowColor: 'rgba(0, 0, 0, 0.1)'
                },
                dark: {
                    backgroundColor: '#1a1a1a',
                    textColor: '#e0e0e0',
                    headerBg: '#242424',
                    borderColor: '#444444',
                    hoverColor: '#333333',
                    primary: '#ff5f5f',
                    buttonHover: 'rgba(255, 95, 95, 0.1)',
                    buttonActive: 'rgba(255, 95, 95, 0.2)',
                    cardBg: '#2a2a2a',
                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                },
                sepia: {
                    backgroundColor: '#f8f3e8',
                    textColor: '#5b4636',
                    headerBg: '#efe8d8',
                    borderColor: '#d8cdb8',
                    hoverColor: '#e8d9c0',
                    primary: '#d4a259',
                    buttonHover: 'rgba(212, 162, 89, 0.2)',
                    buttonActive: 'rgba(212, 162, 89, 0.3)',
                    cardBg: '#f0e6d2',
                    shadowColor: 'rgba(0, 0, 0, 0.2)'
                }
            };
            
            // Initialize the app
            initApp();
            
            async function initApp() {
                // Hide loading spinner by default
                loadingElement.style.display = 'none';
                
                // Load library from localStorage
                loadLibrary();
                
                // Set up event listeners
                setupEventListeners();
            }
            
            function loadLibrary() {
                const storedLibrary = localStorage.getItem(LIBRARY_STORAGE_KEY);
                if (storedLibrary) {
                    library = JSON.parse(storedLibrary);
                    renderLibrary();
                }
            }
            
            function saveLibrary() {
                localStorage.setItem(LIBRARY_STORAGE_KEY, JSON.stringify(library));
                renderLibrary();
            }
            
            function renderLibrary() {
                booksContainer.innerHTML = '';
                
                if (library.length === 0) {
                    emptyState.style.display = 'flex';
                    booksContainer.appendChild(emptyState);
                    return;
                }
                
                emptyState.style.display = 'none';
                
                // Render all books
                library.forEach(book => {
                    renderBookCard(book, booksContainer);
                });
            }
            
            function renderBookCard(book, container) {
                const bookCard = document.createElement('div');
                bookCard.className = 'book-card';
                bookCard.dataset.id = book.id;
                
                const cover = document.createElement('div');
                cover.className = 'book-cover';
                
                // Try to use cover image if available
                if (book.coverUrl) {
                    const img = document.createElement('img');
                    img.src = book.coverUrl;
                    img.alt = book.title || 'Book cover';
                    cover.appendChild(img);
                } else {
                    cover.innerHTML = `<i class="fas fa-book"></i>`;
                }
                
                const info = document.createElement('div');
                info.className = 'book-info';
                
                const title = document.createElement('div');
                title.className = 'book-title';
                title.textContent = book.title || 'Untitled';
                
                const author = document.createElement('div');
                author.className = 'book-author';
                author.textContent = book.creator || 'Unknown Author';
                
                const date = document.createElement('div');
                date.className = 'book-date';
                if (book.addedAt) {
                    date.textContent = `Added: ${formatDate(book.addedAt)}`;
                }
                
                const actions = document.createElement('div');
                actions.className = 'book-actions';
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'book-action-btn';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'Remove from library';
                deleteBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    removeBook(book.id);
                });
                
                actions.appendChild(deleteBtn);
                info.appendChild(title);
                info.appendChild(author);
                info.appendChild(date);
                bookCard.appendChild(cover);
                bookCard.appendChild(info);
                bookCard.appendChild(actions);
                
                bookCard.addEventListener('click', () => {
                    loadBook(book.id);
                    hideLibrary();
                });
                
                container.appendChild(bookCard);
            }
            
            function formatDate(dateString) {
                const date = new Date(dateString);
                return date.toLocaleDateString(undefined, {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric'
                });
            }
            
            function removeBook(bookId) {
                if (confirm('Are you sure you want to remove this book from your library?')) {
                    library = library.filter(book => book.id !== bookId);
                    saveLibrary();
                    
                    // If we're currently viewing the removed book, close it
                    if (currentBookId === bookId) {
                        showLibrary();
                    }
                }
            }
            
            async function addBookByUrl(url) {
                try {
                    // Validate URL
                    if (!url) {
                        throw new Error('Please enter a URL');
                    }
                    
                    if (!url.toLowerCase().endsWith('.epub')) {
                        throw new Error('URL must point to an EPUB file');
                    }
                    
                    // Check if this URL already exists in library
                    const existingBook = library.find(book => book.url === url);
                    if (existingBook) {
                        await loadBook(existingBook.id);
                        return;
                    }
                    
                    // Show loading state
                    loadingElement.innerHTML = `
                        <div class="spinner"></div>
                        <div>Loading EPUB from URL...</div>
                        <div style="font-size: 0.9em; opacity: 0.8; margin-top: 8px;">${url}</div>
                    `;
                    loadingElement.style.display = 'flex';
                    
                    // Generate a unique ID for the book
                    const id = 'book-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
                    
                    // Create a temporary book to get metadata
                    const tempBook = ePub(url);
                    await tempBook.ready;
                    
                    const metadata = await tempBook.loaded.metadata;
                    
                    // Try to get cover image
                    let coverUrl = null;
                    try {
                        const cover = await tempBook.coverUrl();
                        if (cover) {
                            coverUrl = cover;
                        }
                    } catch (e) {
                        console.log("No cover image found");
                    }
                    
                    // Add to library
                    library.push({
                        id: id,
                        title: metadata.title || url.split('/').pop().replace('.epub', ''),
                        creator: metadata.creator || 'Unknown Author',
                        url: url,
                        coverUrl: coverUrl,
                        addedAt: new Date().toISOString()
                    });
                    
                    saveLibrary();
                    
                    // Clean up temporary book
                    tempBook.destroy();
                    
                    // Immediately load the new book
                    await loadBook(id);
                    
                    // Clear the input field
                    epubLinkInput.value = '';
                    
                } catch (error) {
                    console.error("Error adding book by URL:", error);
                    loadingElement.innerHTML = `
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                        <div>Error loading EPUB from URL</div>
                        <div style="margin-top: 10px; font-size: 0.9em;">${error.message}</div>
                        <button onclick="showLibrary()" style="margin-top: 20px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Back to Library
                        </button>
                    `;
                }
            }
            
            function showLibrary() {
                libraryContainer.style.display = 'flex';
                viewerContainer.style.display = 'none';
                titleElement.textContent = 'Awesome EPUB Reader';
                currentBookId = null;
            }
            
            function hideLibrary() {
                libraryContainer.style.display = 'none';
                viewerContainer.style.display = 'flex';
            }
            
            async function loadBook(bookId) {
                const bookData = library.find(book => book.id === bookId);
                if (!bookData) {
                    showLibrary();
                    return;
                }
                
                currentBookId = bookId;
                
                try {
                    loadingElement.style.display = 'flex';
                    loadingElement.innerHTML = `
                        <div class="spinner"></div>
                        <div>Loading ${bookData.title || bookData.url.split('/').pop()}...</div>
                    `;
                    viewerContainer.style.display = 'none'; // Hide viewer while loading

                    // Initialize the book
                    if (book) {
                        book.destroy();
                    }

                    book = ePub(bookData.url);
                    
                    // Show the viewer container now that we're loading
                    viewerContainer.style.display = 'flex';

                    // Wait for book to be ready
                    await book.ready;

                    // Set book title
                    const metadata = await book.loaded.metadata;
                    titleElement.textContent = metadata.title || bookData.url.split('/').pop().replace('.epub', '');

                    // Reset chapter index when loading a new volume
                    currentChapterIndex = 0;

                    // Get spine items (chapters)
                    spineItems = book.spine.spineItems;
                    chapters = spineItems.map((item, index) => {
                        return {
                            id: item.id,
                            href: item.href,
                            index: index,
                            title: item.title || `Section ${index + 1}`
                        };
                    });

                    // Update page info immediately
                    updatePageInfo();

                    // Create rendition with scrolling
                    rendition = book.renderTo("viewer-content", {
                        width: "100%",
                        height: "100%",
                        spread: "none",
                        flow: "scrolled-doc"
                    });

                    // Set up event listeners before displaying
                    setupRenditionListeners();

                    // Display the first chapter
                    await rendition.display(spineItems[0].href);

                    // Get TOC
                    await setupTOC();

                    // Apply current theme
                    applyTheme(currentTheme);

                    // Apply current font size
                    rendition.themes.fontSize(`${fontSize}px`);

                } catch (error) {
                    console.error("Error loading book:", error);
                    loadingElement.innerHTML = `
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                        <div>Error loading book</div>
                        <div style="margin-top: 10px; font-size: 0.9em;">${error.message}</div>
                        <button onclick="showLibrary()" style="margin-top: 20px; padding: 8px 16px; background: var(--primary); color: white; border: none; border-radius: 4px; cursor: pointer;">
                            Back to Library
                        </button>
                    `;
                    return;
                } finally {
                    loadingElement.style.display = 'none';
                }
            }
            
            function setupRenditionListeners() {
                // When a new section is rendered
                rendition.on("rendered", (section) => {
                    const href = section.href;
                    
                    // Find current chapter index
                    for (let i = 0; i < spineItems.length; i++) {
                        if (spineItems[i].href === href) {
                            currentChapterIndex = i;
                            break;
                        }
                    }
                    
                    // Update chapter title
                    const currentChapter = spineItems[currentChapterIndex];
                    let title = currentChapter.title || `Section ${currentChapterIndex + 1}`;
                    chapterTitle.textContent = title;
                    
                    // Update page info
                    updatePageInfo();
                    
                    // Highlight current TOC item
                    highlightCurrentTOCItem();
                    
                    // Reset progress bar
                    progressBar.style.width = '0%';
                });
                
                // Track progress
                rendition.on("relocated", (location) => {
                    if (location && location.start) {
                        const progress = location.start.percentage * 100;
                        progressBar.style.width = `${progress}%`;
                    }
                });
                
                // Handle scroll events
                viewer.addEventListener('scroll', function() {
                    const scrollPercentage = (viewer.scrollTop / (viewer.scrollHeight - viewer.clientHeight)) * 100;
                    progressBar.style.width = `${scrollPercentage}%`;
                });
            }
            
            // Update page information
            function updatePageInfo() {
                if (spineItems && spineItems.length > 0) {
                    pageInfo.textContent = `Section ${currentChapterIndex + 1}/${spineItems.length}`;
                } else {
                    pageInfo.textContent = "Loading...";
                }
            }
            
            // Load chapter content
            async function loadChapter(index) {
                if (isLoading) return false;
                if (index < 0 || index >= spineItems.length) {
                    console.log("Chapter index out of bounds:", index);
                    return false;
                }
                
                isLoading = true;
                
                try {
                    // Get the chapter
                    const chapter = spineItems[index];
                    
                    // Display the chapter
                    await rendition.display(chapter.href);
                    
                    // Update current chapter index
                    currentChapterIndex = index;
                    
                    // Scroll to top of viewer
                    viewer.scrollTo(0, 0);
                    
                    isLoading = false;
                    return true;
                } catch (error) {
                    console.error("Error loading chapter:", error);
                    
                    // Show error in viewer
                    const errorDiv = document.createElement('div');
                    errorDiv.style.textAlign = 'center';
                    errorDiv.style.padding = '20px';
                    errorDiv.innerHTML = `
                        <i class="fas fa-exclamation-triangle" style="font-size: 2rem; color: var(--primary); margin-bottom: 10px;"></i>
                        <p>Error loading chapter: ${error.message}</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">Try navigating to another chapter.</p>
                    `;
                    
                    viewerContent.innerHTML = '';
                    viewerContent.appendChild(errorDiv);
                    
                    isLoading = false;
                    return false;
                }
            }
            
            // Navigation functions
            async function nextChapter() {
                if (currentChapterIndex < spineItems.length - 1) {
                    await loadChapter(currentChapterIndex + 1);
                } else {
                    console.log("Already at last chapter");
                }
            }
            
            async function prevChapter() {
                if (currentChapterIndex > 0) {
                    await loadChapter(currentChapterIndex - 1);
                } else {
                    console.log("Already at first chapter");
                }
            }
            
            // Table of Contents
            async function setupTOC() {
                try {
                    const navigation = await book.loaded.navigation;
                    
                    if (navigation && navigation.toc && navigation.toc.length > 0) {
                        tocElement.innerHTML = '';
                        
                        navigation.toc.forEach((item) => {
                            const div = document.createElement('div');
                            div.className = 'toc-item';
                            div.textContent = item.label;
                            div.dataset.href = item.href;
                            
                            div.addEventListener('click', async function() {
                                await rendition.display(item.href);
                                hideSidebar();
                            });
                            
                            tocElement.appendChild(div);
                        });
                    } else {
                        // If no TOC, create one based on spine items
                        tocElement.innerHTML = '';
                        
                        spineItems.forEach((chapter, index) => {
                            const div = document.createElement('div');
                            div.className = 'toc-item';
                            div.textContent = chapter.title || `Chapter ${index + 1}`;
                            div.dataset.index = index;
                            
                            div.addEventListener('click', async function() {
                                await loadChapter(index);
                                hideSidebar();
                            });
                            
                            tocElement.appendChild(div);
                        });
                    }
                } catch (error) {
                    console.error("Error setting up TOC:", error);
                    tocElement.innerHTML = '<div style="padding: 16px; text-align: center;">Error loading table of contents</div>';
                }
            }
            
            // Highlight current TOC item
            function highlightCurrentTOCItem() {
                const items = document.querySelectorAll('.toc-item');
                items.forEach(item => item.classList.remove('active'));
                
                // Try to find the item by href
                if (spineItems[currentChapterIndex]) {
                    const currentHref = spineItems[currentChapterIndex].href;
                    const hrefItem = document.querySelector(`.toc-item[data-href="${currentHref}"]`);
                    if (hrefItem) {
                        hrefItem.classList.add('active');
                        // Scroll to active item
                        hrefItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        return;
                    }
                }
                
                // If not found by href, try to find by index
                const indexItem = document.querySelector(`.toc-item[data-index="${currentChapterIndex}"]`);
                if (indexItem) {
                    indexItem.classList.add('active');
                    // Scroll to active item
                    indexItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
            
            // Sidebar controls
            function showSidebar() {
                sidebar.classList.add('visible');
                sidebarOverlay.classList.add('visible');
            }
            
            function hideSidebar() {
                sidebar.classList.remove('visible');
                sidebarOverlay.classList.remove('visible');
            }
            
            // Theme functions
            function applyTheme(theme) {
                currentTheme = theme;
                const themeValues = themes[theme];
                
                // Update all CSS variables
                document.documentElement.style.setProperty('--bg-color', themeValues.backgroundColor);
                document.documentElement.style.setProperty('--text-color', themeValues.textColor);
                document.documentElement.style.setProperty('--header-bg', themeValues.headerBg);
                document.documentElement.style.setProperty('--border-color', themeValues.borderColor);
                document.documentElement.style.setProperty('--primary', themeValues.primary);
                document.documentElement.style.setProperty('--hover-color', themeValues.hoverColor);
                document.documentElement.style.setProperty('--button-hover', themeValues.buttonHover);
                document.documentElement.style.setProperty('--button-active', themeValues.buttonActive);
                document.documentElement.style.setProperty('--shadow-color', themeValues.shadowColor);
                document.documentElement.style.setProperty('--card-bg', themeValues.cardBg);
                
                // Apply theme to rendition
                if (rendition) {
                    rendition.themes.default({
                        body: {
                            color: themeValues.textColor,
                            background: themeValues.backgroundColor
                        }
                    });
                }
                
                // Update theme selection
                themeOptions.forEach(option => {
                    option.classList.remove('active');
                    if (option.dataset.theme === theme) {
                        option.classList.add('active');
                    }
                });
            }
            
            // Font size controls
            function adjustFontSize(delta) {
                fontSize = Math.min(Math.max(fontSize + delta, 12), 28);
                if (rendition) {
                    rendition.themes.fontSize(`${fontSize}px`);
                }
            }
            
            function resetFontSize() {
                fontSize = 18;
                if (rendition) {
                    rendition.themes.fontSize(`${fontSize}px`);
                }
            }
            
            // Fullscreen functions
            function toggleFullscreen() {
                if (!document.fullscreenElement) {
                    document.documentElement.requestFullscreen().catch(err => {
                        console.error(`Error attempting to enable fullscreen: ${err.message}`);
                    });
                    fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i>';
                } else {
                    if (document.exitFullscreen) {
                        document.exitFullscreen();
                        fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i>';
                    }
                }
            }
            
            function setupEventListeners() {
                // Navigation
                prevChapterBtn.addEventListener('click', prevChapter);
                nextChapterBtn.addEventListener('click', nextChapter);
                
                // Sidebar controls
                tocToggle.addEventListener('click', showSidebar);
                tocControl.addEventListener('click', showSidebar);
                closeSidebar.addEventListener('click', hideSidebar);
                sidebarOverlay.addEventListener('click', hideSidebar);
                
                // Fullscreen
                fullscreenBtn.addEventListener('click', toggleFullscreen);
                
                // Font controls
                fontDecrease.addEventListener('click', () => adjustFontSize(-1));
                fontIncrease.addEventListener('click', () => adjustFontSize(1));
                fontReset.addEventListener('click', resetFontSize);
                
                // Theme selector
                themeOptions.forEach(option => {
                    option.addEventListener('click', function() {
                        applyTheme(this.dataset.theme);
                    });
                });
                
                // Settings control
                settingsControl.addEventListener('click', function() {
                    showSidebar();
                    document.getElementById('settings-panel').scrollIntoView({ behavior: 'smooth' });
                });
                
                // Library controls
                homeBtn.addEventListener('click', showLibrary);
                closeLibrary.addEventListener('click', hideLibrary);
                
                // URL input handling
                addLinkBtn.addEventListener('click', () => {
                    const url = epubLinkInput.value.trim();
                    if (url) {
                        addBookByUrl(url);
                    }
                });
                
                epubLinkInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        const url = epubLinkInput.value.trim();
                        if (url) {
                            addBookByUrl(url);
                        }
                    }
                });
                
                // Keyboard navigation
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'ArrowLeft') prevChapter();
                    if (e.key === 'ArrowRight') nextChapter();
                    if (e.key === 'Escape') {
                        if (sidebar.classList.contains('visible')) {
                            hideSidebar();
                        } else if (libraryContainer.style.display === 'none') {
                            showLibrary();
                        }
                    }
                    if (e.key === 'f' || e.key === 'F') toggleFullscreen();
                });
            }
            
            // Make showLibrary available globally for error handling
            window.showLibrary = showLibrary;
        });
    </script>
</body>
</html>
